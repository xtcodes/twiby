<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Twibbon Drag & Drop</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f3f3f3;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    .container {
      max-width: 600px;
      margin: auto;
      padding: 30px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      position: relative;
      overflow: hidden;
    }
    .step {
      display: none;
    }
    .step.active {
      display: block;
    }
    .dropzone {
      border: 2px dashed #aaa;
      padding: 30px;
      border-radius: 10px;
      background: #fafafa;
      cursor: pointer;
      margin-top: 15px;
    }
    .square-preview {
      width: 100%;
      padding-top: 100%;
      position: relative;
      background: #eee;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 10px;
    }
    .square-preview img {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    canvas {
      width: 100%;
      max-width: 500px;
      aspect-ratio: 1 / 1;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-top: 10px;
      touch-action: none;
      background-color: #fff;
    }
    .navigation {
      margin-top: 30px;
    }
    .navigation button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 0 10px;
      border: none;
      border-radius: 6px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    .navigation button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    #spinner {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 999;
      display: none;
    }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #countdown {
      font-size: 14px;
      margin-top: 8px;
      color: #888;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Twibbon Drag & Drop</h1>

    <div class="step active" id="step-1">
      <h2>Langkah 1: Unggah Foto</h2>
      <div class="dropzone" id="drop-photo">
        <p>Seret foto ke sini atau klik untuk pilih</p>
        <div class="square-preview"><img id="photo-preview" style="display: none;" /></div>
        <input type="file" id="upload-photo" accept="image/*" style="display: none;" />
      </div>
    </div>

    <div class="step" id="step-2">
      <h2>Langkah 2: Unggah Twibbon (PNG Transparan)</h2>
      <div class="dropzone" id="drop-frame">
        <p>Seret twibbon PNG ke sini atau klik untuk pilih</p>
        <div class="square-preview"><img id="frame-preview" style="display: none;" /></div>
        <input type="file" id="upload-frame" accept="image/png" style="display: none;" />
      </div>
    </div>

    <div class="step" id="step-3">
      <h2>Langkah 3: Atur Posisi Foto</h2>
      <p>Geser dan zoom sebelum menyimpan.</p>
      <canvas id="preview-canvas" width="500" height="500"></canvas>
    </div>

    <div class="step" id="step-4">
      <h2>Langkah 4: Pratinjau & Unduh</h2>
      <canvas id="preview-canvas-final" width="500" height="500"></canvas><br>
      <button id="download-btn">Unduh Hasil</button>
      <div id="countdown">Mohon tunggu...</div>
    </div>

    <div class="navigation">
      <button id="prev-btn" disabled>Sebelumnya</button>
      <button id="next-btn">Selanjutnya</button>
    </div>
  </div>

  <div id="spinner"><div class="loader"></div></div>

  <script>
// script.js
let currentStep = 0;
const steps = document.querySelectorAll(".step");
const prevBtn = document.getElementById("prev-btn");
const nextBtn = document.getElementById("next-btn");
const downloadBtn = document.getElementById("download-btn");
const countdown = document.getElementById("countdown");
const spinner = document.getElementById("spinner");

const photoPreview = document.getElementById("photo-preview");
const framePreview = document.getElementById("frame-preview");
const photoInput = document.getElementById("upload-photo");
const frameInput = document.getElementById("upload-frame");

const canvas = document.getElementById("preview-canvas");
const ctx = canvas.getContext("2d");
const finalCanvas = document.getElementById("preview-canvas-final");
const finalCtx = finalCanvas.getContext("2d");

let photoImage = new Image();
let frameImage = new Image();
let scale = 1;
let position = { x: 0, y: 0 };
let isDragging = false;
let lastTouch = {};
let initialDistance = null;
let isInteracting = false;
let interactionTimeout = null;

function updateSteps() {
  steps.forEach((s, i) => s.classList.toggle("active", i === currentStep));
  prevBtn.disabled = currentStep === 0;
  nextBtn.textContent = currentStep === steps.length - 1 ? "Muat Ulang" : "Selanjutnya";

  if (currentStep === 3) {
    drawCanvas(finalCtx, finalCanvas, false);
  }
}

prevBtn.addEventListener("click", () => {
  if (currentStep > 0) {
    currentStep--;
    updateSteps();
  }
});

nextBtn.addEventListener("click", () => {
  if (nextBtn.textContent === "Muat Ulang") return location.reload();
  if (currentStep === 0 && !photoImage.src) return alert("Unggah foto terlebih dahulu!");
  if (currentStep === 1 && !frameImage.src) return alert("Unggah twibbon terlebih dahulu!");
  if (currentStep < steps.length - 1) {
    currentStep++;
    updateSteps();
  }
});

document.getElementById("drop-photo").addEventListener("click", () => photoInput.click());
photoInput.addEventListener("change", e => delayedLoadImage(e.target.files[0], photoImage, photoPreview));
document.getElementById("drop-photo").addEventListener("drop", e => {
  e.preventDefault();
  delayedLoadImage(e.dataTransfer.files[0], photoImage, photoPreview);
});
document.getElementById("drop-photo").addEventListener("dragover", e => e.preventDefault());

document.getElementById("drop-frame").addEventListener("click", () => frameInput.click());
frameInput.addEventListener("change", e => delayedLoadImage(e.target.files[0], frameImage, framePreview));
document.getElementById("drop-frame").addEventListener("drop", e => {
  e.preventDefault();
  delayedLoadImage(e.dataTransfer.files[0], frameImage, framePreview);
});
document.getElementById("drop-frame").addEventListener("dragover", e => e.preventDefault());

function delayedLoadImage(file, imageEl, previewEl) {
  spinner.style.display = "block";
  setTimeout(() => {
    loadImage(file, imageEl, previewEl);
    spinner.style.display = "none";
  }, 3000);
}

function loadImage(file, imageEl, previewEl) {
  const reader = new FileReader();
  reader.onload = () => {
    imageEl.src = reader.result;
    previewEl.src = reader.result;
    previewEl.style.display = "block";
    drawCanvas();
  };
  reader.readAsDataURL(file);
}

function drawCanvas(ctxDraw = ctx, canvasRef = canvas, transparent = isInteracting) {
  ctxDraw.clearRect(0, 0, canvasRef.width, canvasRef.height);
  if (photoImage.src) {
    const ratio = Math.min(canvasRef.width / photoImage.width, canvasRef.height / photoImage.height);
    const drawWidth = photoImage.width * scale * ratio;
    const drawHeight = photoImage.height * scale * ratio;
    const offsetX = (canvasRef.width - drawWidth) / 2 + position.x;
    const offsetY = (canvasRef.height - drawHeight) / 2 + position.y;
    ctxDraw.drawImage(photoImage, offsetX, offsetY, drawWidth, drawHeight);
  }
  if (frameImage.src) {
    ctxDraw.globalAlpha = transparent ? 0.5 : 1.0;
    ctxDraw.drawImage(frameImage, 0, 0, canvasRef.width, canvasRef.height);
    ctxDraw.globalAlpha = 1.0;
  }
}

downloadBtn.addEventListener("click", () => {
  spinner.style.display = "block";
  countdown.style.display = "block";
  let timeLeft = 15;
  countdown.textContent = `Mohon tunggu ${timeLeft} detik...`;

  const countdownInterval = setInterval(() => {
    timeLeft--;
    countdown.textContent = `Mohon tunggu ${timeLeft} detik...`;
    if (timeLeft <= 0) {
      clearInterval(countdownInterval);
      spinner.style.display = "none";
      countdown.style.display = "none";

      const link = document.createElement("a");
      link.download = "twibbon.png";
      link.href = finalCanvas.toDataURL();
      link.click();
    }
  }, 1000);
});

function startInteraction() {
  isInteracting = true;
  drawCanvas();
  clearTimeout(interactionTimeout);
}
function endInteraction() {
  clearTimeout(interactionTimeout);
  interactionTimeout = setTimeout(() => {
    isInteracting = false;
    drawCanvas();
  }, 300);
}

canvas.addEventListener("mousedown", e => {
  isDragging = true;
  lastTouch = { x: e.offsetX, y: e.offsetY };
  startInteraction();
});
canvas.addEventListener("mousemove", e => {
  if (isDragging) {
    const dx = e.offsetX - lastTouch.x;
    const dy = e.offsetY - lastTouch.y;
    position.x += dx;
    position.y += dy;
    lastTouch = { x: e.offsetX, y: e.offsetY };
    drawCanvas();
  }
});
canvas.addEventListener("mouseup", () => { isDragging = false; endInteraction(); });
canvas.addEventListener("mouseleave", () => { isDragging = false; endInteraction(); });

canvas.addEventListener("wheel", e => {
  e.preventDefault();
  const delta = e.deltaY < 0 ? 0.05 : -0.05;
  scale = Math.max(0.1, Math.min(5, scale + delta));
  startInteraction();
  drawCanvas();
  endInteraction();
});

canvas.addEventListener("touchstart", e => {
  if (e.touches.length === 1) {
    isDragging = true;
    const touch = e.touches[0];
    lastTouch = getTouchPos(touch);
  } else if (e.touches.length === 2) {
    initialDistance = getDistance(e.touches);
  }
  startInteraction();
}, { passive: false });

canvas.addEventListener("touchmove", e => {
  e.preventDefault();
  if (e.touches.length === 1 && isDragging) {
    const touch = getTouchPos(e.touches[0]);
    const dx = touch.x - lastTouch.x;
    const dy = touch.y - lastTouch.y;
    position.x += dx;
    position.y += dy;
    lastTouch = touch;
    drawCanvas();
  } else if (e.touches.length === 2 && initialDistance !== null) {
    const newDist = getDistance(e.touches);
    const zoom = newDist / initialDistance;
    scale = Math.max(0.1, Math.min(5, scale * zoom));
    initialDistance = newDist;
    drawCanvas();
  }
}, { passive: false });

canvas.addEventListener("touchend", () => {
  isDragging = false;
  initialDistance = null;
  endInteraction();
});

function getTouchPos(touch) {
  const rect = canvas.getBoundingClientRect();
  return {
    x: touch.clientX - rect.left,
    y: touch.clientY - rect.top
  };
}

function getDistance(touches) {
  const dx = touches[0].clientX - touches[1].clientX;
  const dy = touches[0].clientY - touches[1].clientY;
  return Math.sqrt(dx * dx + dy * dy);
}

updateSteps();

  </script>
</body>
</html>
