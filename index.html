<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aplikasi Twibbon Interaktif</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #f4f4f4;
      margin: 0;
      padding: 2rem;
    }
    .canvas-container {
      position: relative;
      display: inline-block;
      background: #fff;
      border: 1px solid #ccc;
      touch-action: none;
    }
    canvas {
      max-width: 100%;
      touch-action: none;
    }
    input[type="file"] {
      margin: 1rem 0;
    }
    button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Aplikasi Twibbon Interaktif</h1>
  <div class="canvas-container">
    <canvas id="twibbonCanvas" width="500" height="500"></canvas>
  </div>
  <br />
  <input type="file" id="uploadImage" accept="image/*" />
  <br />
  <button onclick="downloadImage()">Unduh Hasil</button>

  <script>
    const canvas = document.getElementById('twibbonCanvas');
    const ctx = canvas.getContext('2d');
    const container = document.querySelector('.canvas-container');

    let twibbon = new Image();
    twibbon.src = 'twibbon.png'; // Ganti dengan URL twibbon transparan

    let userImage = null;
    let scale = 1;
    let lastScale = 1;
    let position = { x: 0, y: 0 };
    let lastPos = { x: 0, y: 0 };
    let isInteracting = false;
    let pointers = [];

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (userImage) {
        const dx = position.x;
        const dy = position.y;
        const dw = userImage.width * scale;
        const dh = userImage.height * scale;
        ctx.drawImage(userImage, dx, dy, dw, dh);
      }
      ctx.globalAlpha = isInteracting ? 0.5 : 1;
      ctx.drawImage(twibbon, 0, 0, canvas.width, canvas.height);
      ctx.globalAlpha = 1;
    }

    function getTouches(evt) {
      return evt.touches || Array.from(pointers);
    }

    canvas.addEventListener('pointerdown', e => {
      pointers.push(e);
      canvas.setPointerCapture(e.pointerId);
      if (pointers.length === 1) {
        lastPos = { x: e.clientX, y: e.clientY };
        isInteracting = true;
      }
    });

    canvas.addEventListener('pointermove', e => {
      for (let i = 0; i < pointers.length; i++) {
        if (pointers[i].pointerId === e.pointerId) {
          pointers[i] = e;
          break;
        }
      }

      if (pointers.length === 1) {
        const dx = e.clientX - lastPos.x;
        const dy = e.clientY - lastPos.y;
        position.x += dx;
        position.y += dy;
        lastPos = { x: e.clientX, y: e.clientY };
        draw();
      } else if (pointers.length === 2) {
        const [p1, p2] = pointers;
        const dist = Math.hypot(p1.clientX - p2.clientX, p1.clientY - p2.clientY);
        const initialDist = Math.hypot(
          p1.clientX - p2.clientX,
          p1.clientY - p2.clientY
        );
        const center = {
          x: (p1.clientX + p2.clientX) / 2,
          y: (p1.clientY + p2.clientY) / 2
        };
        scale = lastScale * (dist / initialDist);
        draw();
      }
    });

    canvas.addEventListener('pointerup', e => {
      pointers = pointers.filter(p => p.pointerId !== e.pointerId);
      if (pointers.length === 0) {
        lastScale = scale;
        isInteracting = false;
        draw();
      }
    });

    canvas.addEventListener('pointercancel', e => {
      pointers = pointers.filter(p => p.pointerId !== e.pointerId);
    });

    document.getElementById('uploadImage').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (event) {
        const img = new Image();
        img.onload = function () {
          userImage = img;
          scale = 1;
          lastScale = 1;
          position = { x: 0, y: 0 };
          draw();
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    twibbon.onload = draw;

    function downloadImage() {
      const link = document.createElement('a');
      link.download = 'twibbon.png';
      link.href = canvas.toDataURL();
      link.click();
    }
  </script>
</body>
</html>
