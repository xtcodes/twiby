<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Alat Twibbon</title>
  <link rel="stylesheet" href="#" />
  <style>
    body {
  margin: 5em auto;
      padding: 2em;
  font-family: sans-serif;
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  background: #fdfdff;
 /* height: 100vh; */
}

.container {
  max-width: 240px;
  position: relative;
/*  width: 300px;
  height: 300px; */
  touch-action: none;
}

canvas {
  width: 100%;
  height: 100%;
  background-color: #ccc;
  display: block;
  border: 2px solid #ddd;
  border-radius: 10px;
  touch-action: none;
}

#imageInput {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  z-index: 10;
  width: 200px;
  height: 50px;
  opacity: 0;
  cursor: pointer;
}

.button-placeholder {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  background-color: rgba(0, 0, 0, 0.4); /* hitam transparan */
  backdrop-filter: blur(6px); /* efek blur */
  color: white;
  padding: 12px 24px;
  border-radius: 8px;
  text-align: center;
  z-index: 5;
  pointer-events: none;
  font-size: clamp(14px, 4vw, 18px);
  font-weight: bold;
}

.action-buttons {
  margin-top: 20px;
  display: none;
  gap: 10px;
  flex-wrap: wrap;
}

.action-buttons button {
  padding: 10px 20px;
  background-color: #28a745;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
}

#shareBtn {
  background-color: #007BFF;
  display: none;
}

#resetBtn {
  background-color: #dc3545;
  display: none;
}

#twibbonInputBtn {
  background-color: #ffc107;
  display: none;
}

#spinner {
  position: absolute;
  bottom: 10px;
  right: 10px;
  width: 30px;
  height: 30px;
  border: 4px solid #fff;
  border-top: 4px solid #333;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  display: none;
  z-index: 20;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

#processingOverlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(200, 200, 200, 0.8);
  color: #333;
  font-size: 18px;
  font-weight: bold;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 15;
  display: none;
}

#downloadNote {
  margin-top: 10px;
  font-size: 16px;
  display: none;
  color: #333;
}
    a:link, a:visited {
        color: #38488f;
        text-decoration: none;
    }
    @media (min-width: 640px) {
        .container {
          max-width: none;
           /* margin: 0 auto;
            width: auto; */
        }
  }

  </style>
</head>
<body>
  <div class="container">
    <p>Ini adalah situs web tempat Anda dapat menambahkan foto dalam bingkai.</p>
    <canvas id="twibbonCanvas" width="1024" height="1024"></canvas>
    <div id="processingOverlay">Sedang proses... (<span id="countdown">15</span>)</div>
    <div id="spinner"></div>
    <input type="file" accept="image/*" id="imageInput" />
    <div class="button-placeholder" id="buttonText">UNGGAH GAMBAR</div>
  </div>

  <div class="action-buttons" id="actions">
    <button id="downloadBtn">Unduh Hasil</button>
    <button id="shareBtn">Bagikan</button>
    <button id="resetBtn">Reset Awal</button>
    <button id="twibbonInputBtn">Unggah Twibbon</button>
  </div>

  <div id="downloadNote">
    Jika unduhan tidak dimulai otomatis, <a id="manualDownload" href="#" download="twibbon.png">klik di sini</a>.
  </div>

  <script>
const canvas = document.getElementById('twibbonCanvas');
const ctx = canvas.getContext('2d');
const imageInput = document.getElementById('imageInput');
const downloadBtn = document.getElementById('downloadBtn');
const shareBtn = document.getElementById('shareBtn');
const resetBtn = document.getElementById('resetBtn');
const twibbonInputBtn = document.getElementById('twibbonInputBtn');
const processingOverlay = document.getElementById('processingOverlay');
const spinner = document.getElementById('spinner');
const countdownEl = document.getElementById('countdown');
const manualDownload = document.getElementById('manualDownload');
const downloadNote = document.getElementById('downloadNote');
const buttonText = document.getElementById('buttonText');
const actions = document.getElementById('actions');

let userImage = null;
let twibbonImage = null;
let isDragging = false;
let lastTouchDist = null;
let offsetX = 0;
let offsetY = 0;
let scale = 1;
let startX, startY;

const placeholderImage = new Image();
placeholderImage.src = 'placeholder.jpeg';

const defaultTwibbon = new Image();
defaultTwibbon.src = 'twibbon.png';
defaultTwibbon.onload = () => {
  twibbonImage = defaultTwibbon;
  drawCanvas();
};

function drawCanvas(isInteracting = false) {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (userImage) {
    const aspectRatio = userImage.width / userImage.height;
    let drawWidth = userImage.width * scale;
    let drawHeight = userImage.height * scale;

    if (drawWidth > canvas.width || drawHeight > canvas.height) {
      const ratio = Math.min(canvas.width / drawWidth, canvas.height / drawHeight);
      drawWidth *= ratio;
      drawHeight *= ratio;
    }

    ctx.drawImage(userImage, offsetX, offsetY, drawWidth, drawHeight);
  } else {
    ctx.drawImage(placeholderImage, 0, 0, canvas.width, canvas.height);
  }

  if (twibbonImage && userImage) {
    ctx.globalAlpha = isInteracting ? 0.5 : 1;
    ctx.drawImage(twibbonImage, 0, 0, canvas.width, canvas.height);
    ctx.globalAlpha = 1.0;
  }
}

canvas.addEventListener('touchstart', (e) => {
  if (e.touches.length === 1) {
    isDragging = true;
    startX = e.touches[0].clientX - offsetX;
    startY = e.touches[0].clientY - offsetY;
  } else if (e.touches.length === 2) {
    lastTouchDist = getTouchDistance(e.touches);
  }
});

canvas.addEventListener('touchmove', (e) => {
  e.preventDefault();
  if (e.touches.length === 1 && isDragging) {
    offsetX = e.touches[0].clientX - startX;
    offsetY = e.touches[0].clientY - startY;
    drawCanvas(true);
  } else if (e.touches.length === 2) {
    const dist = getTouchDistance(e.touches);
    if (lastTouchDist) {
      const zoom = dist / lastTouchDist;
      scale *= zoom;
      lastTouchDist = dist;
      drawCanvas(true);
    }
  }
});

canvas.addEventListener('touchend', () => {
  isDragging = false;
  lastTouchDist = null;
  drawCanvas();
});

function getTouchDistance(touches) {
  const dx = touches[0].clientX - touches[1].clientX;
  const dy = touches[0].clientY - touches[1].clientY;
  return Math.sqrt(dx * dx + dy * dy);
}

imageInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (event) {
    const img = new Image();
    img.onload = function () {
      userImage = img;
      offsetX = 0;
      offsetY = 0;
      scale = 1;
      drawCanvas();
      actions.style.display = 'flex';
      downloadBtn.style.display = 'inline-block';
      twibbonInputBtn.style.display = 'inline-block';
      imageInput.style.display = 'none';
      buttonText.style.display = 'none';
    };
    img.src = event.target.result;
  };
  reader.readAsDataURL(file);
});

twibbonInputBtn.addEventListener('click', () => {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.onchange = function (e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function (event) {
      const img = new Image();
      img.onload = function () {
        twibbonImage = img;
        drawCanvas();
      };
      img.src = event.target.result;
    };
    reader.readAsDataURL(file);
  };
  input.click();
});

downloadBtn.addEventListener('click', () => {
  processingOverlay.style.display = 'flex';
  spinner.style.display = 'block';
  let count = 15;
  countdownEl.textContent = count;
  const countdown = setInterval(() => {
    count--;
    countdownEl.textContent = count;
    if (count <= 0) {
      clearInterval(countdown);
      spinner.style.display = 'none';
      processingOverlay.style.display = 'none';

      const dataURL = canvas.toDataURL('image/png');
      const link = document.createElement('a');
      link.download = 'twibbon.png';
      link.href = dataURL;
      link.click();

      manualDownload.href = dataURL;
      downloadNote.style.display = 'block';

      shareBtn.style.display = 'inline-block';
      resetBtn.style.display = 'inline-block';
      downloadBtn.style.display = 'none';
      twibbonInputBtn.style.display = 'none';
    }
  }, 1000);
});

resetBtn.addEventListener('click', () => {
  userImage = null;
  offsetX = 0;
  offsetY = 0;
  scale = 1;
  actions.style.display = 'none';
  downloadNote.style.display = 'none';
  shareBtn.style.display = 'none';
  resetBtn.style.display = 'none';
  imageInput.value = '';
  imageInput.style.display = 'block';
  buttonText.style.display = 'block';
  drawCanvas();
});

shareBtn.addEventListener('click', async () => {
  try {
    const blob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/png'));
    const file = new File([blob], 'twibbon.png', { type: 'image/png' });
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      await navigator.share({
        files: [file],
        title: 'Twibbon Saya',
        text: 'Lihat hasil Twibbon saya!'
      });
    } else {
      alert('Perangkat ini tidak mendukung fitur bagikan file. Silakan unduh manual.');
    }
  } catch (error) {
    console.error('Gagal membagikan:', error);
    alert('Terjadi kesalahan saat membagikan gambar.');
  }
});

drawCanvas();

    </script>
</body>
</html>
