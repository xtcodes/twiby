<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Twibbon Geser & Zoom</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    canvas { border: 1px solid #ccc; max-width: 100%; background-color: #f5f5f5; touch-action: none; margin-top: 20px; }
    .btn { padding: 10px 16px; margin: 10px 5px; font-size: 16px; cursor: pointer; }
    input[type="file"], #unggahTwibbonBtn, #twibbonDefaultBtn, #unduhBtn, #bagikanBtn { display: none; }

    #spinner {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 36px;
      height: 36px;
      border: 4px solid #ccc;
      border-top: 4px solid #333;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      z-index: 999;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <h2>Alat Twibbon Geser & Zoom</h2>

  <button id="unggahGambarBtn" class="btn">Unggah Gambar</button>
  <input type="file" id="unggahGambarInput" accept="image/*" />
  <input type="file" id="unggahTwibbonInput" accept="image/*" />
  <button id="unggahTwibbonBtn" class="btn">Unggah Twibbon</button>
  <button id="twibbonDefaultBtn" class="btn">Twibbon Default</button>
  <button id="unduhBtn" class="btn">Unduh Hasil</button>
  <button id="bagikanBtn" class="btn">Bagikan</button>

  <canvas id="kanvas" width="500" height="500"></canvas>
  <div id="spinner"></div>

  <script>
    const unggahGambarBtn = document.getElementById('unggahGambarBtn');
    const unggahGambarInput = document.getElementById('unggahGambarInput');
    const unggahTwibbonInput = document.getElementById('unggahTwibbonInput');
    const unggahTwibbonBtn = document.getElementById('unggahTwibbonBtn');
    const twibbonDefaultBtn = document.getElementById('twibbonDefaultBtn');
    const unduhBtn = document.getElementById('unduhBtn');
    const bagikanBtn = document.getElementById('bagikanBtn');
    const spinner = document.getElementById('spinner');
    const kanvas = document.getElementById('kanvas');
    const ctx = kanvas.getContext('2d');

    let gambarPengguna = null;
    let twibbon = null;
    let hasilDataURL = null;
    const twibbonDefaultSrc = 'twibbon.png';

    let offsetX = 0, offsetY = 0;
    let scale = 1;
    let lastTouchDistance = null;
    let lastTouchPos = null;
    let interaksiAktif = false;

    function tampilkanPlaceholder() {
      ctx.clearRect(0, 0, kanvas.width, kanvas.height);
      ctx.fillStyle = '#aaa';
      ctx.font = '20px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('Unggah gambar untuk memulai', kanvas.width / 2, kanvas.height / 2);
    }

    function resetCanvas() {
      ctx.clearRect(0, 0, kanvas.width, kanvas.height);
    }

    function tampilkanGambarDanTwibbon() {
      if (!gambarPengguna) return;
      resetCanvas();

      const imgRatio = gambarPengguna.width / gambarPengguna.height;
      const canvasRatio = kanvas.width / kanvas.height;

      let drawWidth, drawHeight;
      if (imgRatio > canvasRatio) {
        drawWidth = kanvas.width;
        drawHeight = drawWidth / imgRatio;
      } else {
        drawHeight = kanvas.height;
        drawWidth = drawHeight * imgRatio;
      }

      const centerX = (kanvas.width - drawWidth) / 2;
      const centerY = (kanvas.height - drawHeight) / 2;

      ctx.save();
      ctx.translate(offsetX, offsetY);
      ctx.scale(scale, scale);
      ctx.drawImage(gambarPengguna, centerX, centerY, drawWidth, drawHeight);
      ctx.restore();

      if (twibbon) {
        ctx.save();
        ctx.globalAlpha = interaksiAktif ? 0.5 : 1.0;
        ctx.drawImage(twibbon, 0, 0, kanvas.width, kanvas.height);
        ctx.restore();
      }
    }

    function getDistance(touches) {
      const dx = touches[0].clientX - touches[1].clientX;
      const dy = touches[0].clientY - touches[1].clientY;
      return Math.sqrt(dx * dx + dy * dy);
    }

    unggahGambarBtn.addEventListener('click', () => unggahGambarInput.click());

    unggahGambarInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(event) {
        gambarPengguna = new Image();
        gambarPengguna.onload = () => {
          unggahGambarBtn.style.display = 'none';
          unggahTwibbonBtn.style.display = 'inline-block';
          twibbonDefaultBtn.style.display = 'inline-block';
          tampilkanGambarDanTwibbon();
        };
        gambarPengguna.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    unggahTwibbonBtn.addEventListener('click', () => unggahTwibbonInput.click());

    unggahTwibbonInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(event) {
        twibbon = new Image();
        twibbon.onload = () => {
          tampilkanGambarDanTwibbon();
          unduhBtn.style.display = 'inline-block';
          twibbonDefaultBtn.style.display = 'none';
        };
        twibbon.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    twibbonDefaultBtn.addEventListener('click', () => {
      twibbon = new Image();
      twibbon.crossOrigin = 'anonymous';
      twibbon.onload = () => {
        tampilkanGambarDanTwibbon();
        unduhBtn.style.display = 'inline-block';
        twibbonDefaultBtn.style.display = 'none';
      };
      twibbon.src = twibbonDefaultSrc;
    });

    unduhBtn.addEventListener('click', () => {
      spinner.style.display = 'block';

      // Overlay proses
      ctx.save();
      ctx.fillStyle = 'rgba(200,200,200,0.8)';
      ctx.fillRect(0, 0, kanvas.width, kanvas.height);
      ctx.fillStyle = '#333';
      ctx.font = '20px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('Sedang proses...', kanvas.width / 2, kanvas.height / 2);
      ctx.restore();

      setTimeout(() => {
        hasilDataURL = kanvas.toDataURL();
        const link = document.createElement('a');
        link.download = 'twibbon.png';
        link.href = hasilDataURL;
        link.click();

        spinner.style.display = 'none';
        unduhBtn.style.display = 'none';
        bagikanBtn.style.display = 'inline-block';
        tampilkanGambarDanTwibbon();
      }, 15000);
    });

    bagikanBtn.addEventListener('click', async () => {
      try {
        const blob = await (await fetch(hasilDataURL)).blob();
        const file = new File([blob], 'twibbon.png', { type: blob.type });

        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({
            title: 'Twibbon Saya',
            text: 'Lihat hasil twibbon saya!',
            files: [file]
          });
        } else if (navigator.share) {
          await navigator.share({
            title: 'Twibbon Saya',
            text: 'Lihat hasil twibbon saya!',
            url: window.location.href
          });
        } else {
          alert('Web Share API tidak didukung di perangkat ini.');
        }
      } catch (err) {
        alert('Gagal membagikan.');
        console.error(err);
      }
    });

    // Gestur
    kanvas.addEventListener('touchstart', (e) => {
      if (e.touches.length === 1) {
        lastTouchPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
      } else if (e.touches.length === 2) {
        lastTouchDistance = getDistance(e.touches);
      }
    });

    kanvas.addEventListener('touchmove', (e) => {
      e.preventDefault();
      interaksiAktif = true;
      if (e.touches.length === 1 && lastTouchPos) {
        const dx = e.touches[0].clientX - lastTouchPos.x;
        const dy = e.touches[0].clientY - lastTouchPos.y;
        offsetX += dx;
        offsetY += dy;
        lastTouchPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        tampilkanGambarDanTwibbon();
      } else if (e.touches.length === 2) {
        const newDistance = getDistance(e.touches);
        if (lastTouchDistance) {
          const delta = newDistance / lastTouchDistance;
          scale *= delta;
          lastTouchDistance = newDistance;
          tampilkanGambarDanTwibbon();
        }
      }
    });

    kanvas.addEventListener('touchend', (e) => {
      if (e.touches.length < 2) lastTouchDistance = null;
      if (e.touches.length < 1) lastTouchPos = null;
      interaksiAktif = false;
      tampilkanGambarDanTwibbon();
    });

    tampilkanPlaceholder();
  </script>
</body>
</html>
