<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Twibbon Generator</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
  font-family: Arial, sans-serif;
  background: #222;
  color: #fff;
  text-align: center;
  margin: 0;
  padding: 1rem;
}

.container {
  position: relative;
  max-width: 100vw;
}

canvas {
  width: 100%;
  height: auto;
  background: #ccc;
  touch-action: none;
}

.upload-btn {
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(8px);
  padding: 0.8rem 1.2rem;
  border: none;
  margin-top: 1rem;
  cursor: pointer;
  color: #fff;
  border-radius: 8px;
  font-size: clamp(14px, 3vw, 18px);
  display: inline-block;
}

.upload-twibbon {
  background: #333;
  padding: 0.6rem 1rem;
  border: none;
  margin-top: 1rem;
  cursor: pointer;
  color: #fff;
  border-radius: 8px;
  font-size: 1rem;
  display: inline-block;
}

button {
  background: #00aaff;
  padding: 0.7rem 1.3rem;
  border: none;
  border-radius: 6px;
  color: #fff;
  margin: 0.5rem;
  font-size: 1rem;
  cursor: pointer;
}

#downloadNote {
  margin-top: 1rem;
  font-size: 0.9rem;
  color: #ccc;
}

#downloadNote a {
  color: #00ddff;
  text-decoration: underline;
}

#processingOverlay {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 2rem;
  border-radius: 10px;
  display: none;
  font-size: 1.5rem;
  z-index: 10;
}

#spinner {
  position: absolute;
  bottom: 10px;
  right: 10px;
  width: 30px;
  height: 30px;
  border: 4px solid rgba(255, 255, 255, 0.3);
  border-top: 4px solid white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  display: none;
  z-index: 10;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

  </style>
</head>
<body>
  <div class="container">
    <canvas id="canvas" width="1080" height="1080"></canvas>

    <label for="imageInput" class="upload-btn">UNGGAH GAMBAR
      <input type="file" accept="image/*" id="imageInput" hidden />
    </label>

    <label for="twibbonInput" id="twibbonInputBtn" class="upload-twibbon" style="display: none">
      <input type="file" accept="image/*" id="twibbonInput" hidden />
      Unggah Twibbon
    </label>

    <button id="downloadBtn">Unduh Hasil</button>
    <button id="resetBtn" style="display: none">Reset Awal</button>
    <button id="shareBtn" style="display: none">Bagikan</button>

    <div id="downloadNote" style="display: none"></div>

    <div id="processingOverlay">Sedang proses... (15)</div>
    <div id="spinner"></div>
  </div>

  <script>
    const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let baseImage = null;
let twibbonImage = new Image();
twibbonImage.src = "twibbon.png"; // <- twibbon default tetap digunakan

let placeholderImage = new Image();
placeholderImage.src = "placeholder.png";

let offsetX = 0;
let offsetY = 0;
let scale = 1;
let lastX, lastY;
let isDragging = false;
let initialDistance = null;
let isInteracting = false;

const imageInput = document.getElementById("imageInput");
const twibbonInput = document.getElementById("twibbonInput");
const twibbonInputBtn = document.getElementById("twibbonInputBtn");
const downloadBtn = document.getElementById("downloadBtn");
const resetBtn = document.getElementById("resetBtn");
const shareBtn = document.getElementById("shareBtn");
const spinner = document.getElementById("spinner");
const processingOverlay = document.getElementById("processingOverlay");
const downloadNote = document.getElementById("downloadNote");

function drawCanvas() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (!baseImage) {
    ctx.drawImage(placeholderImage, 0, 0, canvas.width, canvas.height);
    return;
  }

  ctx.save();
  ctx.translate(offsetX, offsetY);
  ctx.scale(scale, scale);

  // proporsional
  const aspectRatio = baseImage.width / baseImage.height;
  let drawWidth = canvas.width;
  let drawHeight = drawWidth / aspectRatio;

  if (drawHeight > canvas.height) {
    drawHeight = canvas.height;
    drawWidth = drawHeight * aspectRatio;
  }

  const dx = (canvas.width - drawWidth) / 2 / scale;
  const dy = (canvas.height - drawHeight) / 2 / scale;

  ctx.drawImage(baseImage, dx, dy, drawWidth / scale, drawHeight / scale);
  ctx.restore();

  if (baseImage && twibbonImage) {
    ctx.globalAlpha = isInteracting ? 0.4 : 1;
    ctx.drawImage(twibbonImage, 0, 0, canvas.width, canvas.height);
    ctx.globalAlpha = 1;
  }
}

function getDistance(t1, t2) {
  return Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
}

function handleStart(e) {
  isInteracting = true;
  if (e.touches.length === 1) {
    isDragging = true;
    lastX = e.touches[0].clientX;
    lastY = e.touches[0].clientY;
  } else if (e.touches.length === 2) {
    initialDistance = getDistance(e.touches[0], e.touches[1]);
  }
}

function handleMove(e) {
  if (e.touches.length === 1 && isDragging) {
    const dx = e.touches[0].clientX - lastX;
    const dy = e.touches[0].clientY - lastY;
    offsetX += dx;
    offsetY += dy;
    lastX = e.touches[0].clientX;
    lastY = e.touches[0].clientY;
  } else if (e.touches.length === 2 && initialDistance) {
    const newDist = getDistance(e.touches[0], e.touches[1]);
    const scaleChange = newDist / initialDistance;
    scale *= scaleChange;
    initialDistance = newDist;
  }
  drawCanvas();
}

function handleEnd() {
  isDragging = false;
  isInteracting = false;
  drawCanvas();
}

imageInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    baseImage = new Image();
    baseImage.onload = () => {
      imageInput.style.display = "none";
      twibbonInputBtn.style.display = "inline-block";
      drawCanvas();
    };
    baseImage.src = reader.result;
  };
  reader.readAsDataURL(file);
});

twibbonInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    twibbonImage = new Image();
    twibbonImage.onload = drawCanvas;
    twibbonImage.src = reader.result;
  };
  reader.readAsDataURL(file);
});

downloadBtn.addEventListener("click", () => {
  processingOverlay.style.display = "flex";
  spinner.style.display = "block";

  let countdown = 15;
  processingOverlay.innerText = `Sedang proses... (${countdown})`;

  const interval = setInterval(() => {
    countdown--;
    processingOverlay.innerText = `Sedang proses... (${countdown})`;

    if (countdown <= 0) {
      clearInterval(interval);
      processingOverlay.style.display = "none";
      spinner.style.display = "none";

      canvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "twibbon.png";
        a.click();

        downloadNote.style.display = "block";
        downloadNote.innerHTML = `Jika unduhan tidak dimulai otomatis, <a href="${url}" download="twibbon.png">klik di sini</a>.`;

        downloadBtn.style.display = "none";
        shareBtn.style.display = "inline-block";
        resetBtn.style.display = "inline-block";
        twibbonInputBtn.style.display = "none";
      });
    }
  }, 1000);
});

resetBtn.addEventListener("click", () => {
  baseImage = null;
  offsetX = 0;
  offsetY = 0;
  scale = 1;
  imageInput.value = "";
  twibbonInput.value = "";

  imageInput.style.display = "block";
  twibbonInputBtn.style.display = "none";
  downloadBtn.style.display = "inline-block";
  resetBtn.style.display = "none";
  shareBtn.style.display = "none";
  downloadNote.style.display = "none";

  drawCanvas();
});

shareBtn.addEventListener("click", async () => {
  try {
    const blob = await new Promise((resolve) =>
      canvas.toBlob(resolve, "image/png")
    );
    const file = new File([blob], "twibbon.png", { type: "image/png" });

    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      await navigator.share({
        files: [file],
        title: "Twibbon Saya",
        text: "Lihat hasil Twibbon saya!",
      });
    } else {
      alert("Perangkat tidak mendukung berbagi file.");
    }
  } catch (e) {
    alert("Gagal membagikan.");
  }
});

canvas.addEventListener("touchstart", handleStart, { passive: false });
canvas.addEventListener("touchmove", handleMove, { passive: false });
canvas.addEventListener("touchend", handleEnd, { passive: false });

placeholderImage.onload = drawCanvas;

  </script>
</body>
</html>
