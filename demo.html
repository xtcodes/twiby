<!DOCTYPE html>
<html lang="id">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <link rel="icon" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aplikasi Twibbon</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f3f3f3;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    .step { display: none; }
    .step.active { display: block; margin: 20px; }
    canvas { max-width: 90%; background: #fff; border: 1px solid #ccc; }
    .buttons { margin-top: 20px; }
    #spinner, #countdown, #notification, #share-btn { display: none; }
    #spinner { margin: 10px auto; border: 4px solid #f3f3f3; border-top: 4px solid #000; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    #notification.show { display: block; background: rgba(0,0,0,0.8); color: white; padding: 10px; margin-top: 10px; border-radius: 5px; }
    .drop-zone { border: 2px dashed #aaa; padding: 20px; cursor: pointer; background: #eee; position: relative; }
    .drop-zone img { max-width: 100px; display: none; }
    .exit-dialog {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75);
      display: flex; align-items: center; justify-content: center; z-index: 9999;
    }
    .exit-dialog .dialog-content {
      background: #222; color: white; padding: 20px 30px; border-radius: 10px;
      text-align: center; max-width: 300px;
    }
    .exit-dialog .dialog-buttons { margin-top: 20px; display: flex; justify-content: space-between; gap: 10px; }
    .exit-dialog button {
      padding: 10px 20px; background: white; color: black; border: none; cursor: pointer; border-radius: 5px;
    }
    .exit-dialog.hidden { display: none; }
  </style>
</head>
<body>
  <h1>Aplikasi Twibbon</h1>

  <div class="step active">
    <h2>Langkah 1: Unggah Foto</h2>
    <div id="drop-photo" class="drop-zone">
      <p>Klik atau seret foto ke sini</p>
      <img id="photo-preview" alt="Pratinjau Foto" />
    </div>
    <input type="file" id="upload-photo" accept="image/*" hidden />
  </div>

  <div class="step">
    <h2>Langkah 2: Unggah Twibbon (PNG Transparan)</h2>
    <div id="drop-frame" class="drop-zone">
      <p>Klik atau seret twibbon ke sini</p>
      <img id="frame-preview" alt="Pratinjau Twibbon" />
    </div>
    <input type="file" id="upload-frame" accept="image/png" hidden />
  </div>

  <div class="step">
    <h2>Langkah 3: Atur Posisi Foto</h2>
    <canvas id="preview-canvas" width="500" height="500"></canvas>
  </div>

  <div class="step">
    <h2>Langkah 4: Pratinjau & Unduh</h2>
    <canvas id="preview-canvas-final" width="500" height="500"></canvas>
    <div id="spinner"></div>
    <div id="countdown"></div>
    <button id="download-btn">Unduh</button>
    <button id="share-btn">Bagikan</button>
  </div>

  <div class="buttons">
    <button id="prev-btn">Sebelumnya</button>
    <button id="next-btn">Selanjutnya</button>
  </div>
  <div id="notification"></div>

  <!-- Dialog konfirmasi keluar -->
  <div id="exit-dialog" class="exit-dialog hidden">
    <div class="dialog-content">
      <p>Apakah kamu yakin ingin keluar tanpa menyimpan hasil Twibbon?</p>
      <div class="dialog-buttons">
        <button id="cancel-exit">Batal</button>
        <button id="confirm-exit">Keluar</button>
      </div>
    </div>
  </div>

  <script>
// Seluruh isi script.js disisipkan di sini

let currentStep = 0;
const steps = document.querySelectorAll(".step");
const prevBtn = document.getElementById("prev-btn");
const nextBtn = document.getElementById("next-btn");
const downloadBtn = document.getElementById("download-btn");
const shareBtn = document.getElementById("share-btn");
const countdown = document.getElementById("countdown");
const spinner = document.getElementById("spinner");
const notification = document.getElementById("notification");

const photoPreview = document.getElementById("photo-preview");
const framePreview = document.getElementById("frame-preview");
const photoInput = document.getElementById("upload-photo");
const frameInput = document.getElementById("upload-frame");

const canvas = document.getElementById("preview-canvas");
const ctx = canvas.getContext("2d");
const finalCanvas = document.getElementById("preview-canvas-final");
const finalCtx = finalCanvas.getContext("2d");

let photoImage = new Image();
let frameImage = new Image();
let scale = 1;
let position = { x: 0, y: 0 };
let isDragging = false;
let lastTouch = {};
let initialDistance = null;
let isInteracting = false;
let interactionTimeout = null;
let unsavedChanges = false;

function showNotification(message) {
  notification.textContent = message;
  notification.classList.add("show");
  setTimeout(() => notification.classList.remove("show"), 3000);
}

function updateSteps() {
  steps.forEach((s, i) => s.classList.toggle("active", i === currentStep));
  prevBtn.disabled = currentStep === 0;
  nextBtn.textContent = currentStep === steps.length - 1 ? "Muat Ulang" : "Selanjutnya";
  if (currentStep === 3) {
    finalCanvas.width = 1080;
    finalCanvas.height = 1080;
    drawCanvas(finalCtx, finalCanvas, false, true);
  }
}

prevBtn.addEventListener("click", () => {
  if (currentStep > 0) {
    currentStep--;
    updateSteps();
  }
});

nextBtn.addEventListener("click", () => {
  if (nextBtn.textContent === "Muat Ulang") return location.reload();
  if (currentStep === 0 && !photoImage.src) return showNotification("Unggah foto terlebih dahulu!");
  if (currentStep === 1 && !frameImage.src) return showNotification("Unggah twibbon terlebih dahulu!");
  if (currentStep < steps.length - 1) {
    currentStep++;
    updateSteps();
  }
});

document.getElementById("drop-photo").addEventListener("click", () => photoInput.click());
photoInput.addEventListener("change", e => delayedLoadImage(e.target.files[0], photoImage, photoPreview));
document.getElementById("drop-photo").addEventListener("drop", e => {
  e.preventDefault();
  delayedLoadImage(e.dataTransfer.files[0], photoImage, photoPreview);
});
document.getElementById("drop-photo").addEventListener("dragover", e => e.preventDefault());

document.getElementById("drop-frame").addEventListener("click", () => frameInput.click());
frameInput.addEventListener("change", e => delayedLoadImage(e.target.files[0], frameImage, framePreview, true));
document.getElementById("drop-frame").addEventListener("drop", e => {
  e.preventDefault();
  delayedLoadImage(e.dataTransfer.files[0], frameImage, framePreview, true);
});
document.getElementById("drop-frame").addEventListener("dragover", e => e.preventDefault());

function delayedLoadImage(file, imageEl, previewEl, checkTransparency = false) {
  spinner.style.display = "block";
  setTimeout(() => {
    loadImage(file, imageEl, previewEl, checkTransparency);
    spinner.style.display = "none";
  }, 3000);
}

function loadImage(file, imageEl, previewEl, checkTransparency = false) {
  const reader = new FileReader();
  reader.onload = () => {
    imageEl.onload = () => {
      if (checkTransparency && !hasTransparency(imageEl)) {
        showNotification("Twibbon harus berupa file PNG dengan latar belakang transparan!");
        frameInput.value = "";
        framePreview.style.display = "none";
        frameImage.src = "";
        return;
      }
      previewEl.src = reader.result;
      unsavedChanges = true;
      previewEl.style.display = "block";
      drawCanvas();
    };
    imageEl.src = reader.result;
  };
  reader.readAsDataURL(file);
}

function hasTransparency(img) {
  const tempCanvas = document.createElement("canvas");
  const tempCtx = tempCanvas.getContext("2d");
  tempCanvas.width = img.width;
  tempCanvas.height = img.height;
  tempCtx.drawImage(img, 0, 0);
  const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
  for (let i = 3; i < imageData.data.length; i += 4) {
    if (imageData.data[i] < 255) return true;
  }
  return false;
}

function drawCanvas(ctxDraw = ctx, canvasRef = canvas, transparent = isInteracting, showWatermark = false) {
  ctxDraw.clearRect(0, 0, canvasRef.width, canvasRef.height);
  if (photoImage.src) {
    const ratio = Math.min(canvasRef.width / photoImage.width, canvasRef.height / photoImage.height);
    const drawWidth = photoImage.width * scale * ratio;
    const drawHeight = photoImage.height * scale * ratio;
    const offsetX = (canvasRef.width - drawWidth) / 2 + position.x;
    const offsetY = (canvasRef.height - drawHeight) / 2 + position.y;
    ctxDraw.drawImage(photoImage, offsetX, offsetY, drawWidth, drawHeight);
  }
  if (frameImage.src) {
    ctxDraw.globalAlpha = transparent ? 0.5 : 1.0;
    ctxDraw.drawImage(frameImage, 0, 0, canvasRef.width, canvasRef.height);
    ctxDraw.globalAlpha = 1.0;
  }
  if (showWatermark) {
    ctxDraw.fillStyle = "white";
    ctxDraw.font = `${Math.floor(canvasRef.width * 0.035)}px sans-serif`;
    ctxDraw.textAlign = "right";
    ctxDraw.textBaseline = "bottom";
    ctxDraw.fillText("@TwibbonApp", canvasRef.width - 20, canvasRef.height - 20);
  }
}

downloadBtn.addEventListener("click", () => {
  spinner.style.display = "block";
  countdown.style.display = "block";
  let timeLeft = 15;
  countdown.textContent = `Mohon tunggu ${timeLeft} detik...`;
  const countdownInterval = setInterval(() => {
    timeLeft--;
    countdown.textContent = `Mohon tunggu ${timeLeft} detik...`;
    if (timeLeft <= 0) {
      clearInterval(countdownInterval);
      spinner.style.display = "none";
      countdown.style.display = "none";
      const hdCanvas = document.createElement("canvas");
      hdCanvas.width = 1080;
      hdCanvas.height = 1080;
      const hdCtx = hdCanvas.getContext("2d");
      drawCanvas(hdCtx, hdCanvas, false, true);
      const link = document.createElement("a");
      link.download = "twibbon-hd.png";
      link.href = hdCanvas.toDataURL();
      link.click();
      downloadBtn.style.display = "none";
      shareBtn.style.display = "inline-block";
      unsavedChanges = false;
    }
  }, 1000);
});

shareBtn.addEventListener("click", async () => {
  try {
    const hdCanvas = document.createElement("canvas");
    hdCanvas.width = 1080;
    hdCanvas.height = 1080;
    const hdCtx = hdCanvas.getContext("2d");
    drawCanvas(hdCtx, hdCanvas, false, true);
    hdCanvas.toBlob(async (blob) => {
      const file = new File([blob], "twibbon.png", { type: "image/png" });
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({ title: "Bagikan Twibbon", text: "Lihat hasil twibbon saya!", files: [file] });
        unsavedChanges = false;
      } else {
        showNotification("Perangkat tidak mendukung Web Share API dengan file.");
      }
    });
  } catch (err) {
    showNotification("Gagal membagikan gambar.");
  }
});

const exitDialog = document.getElementById("exit-dialog");
const cancelExitBtn = document.getElementById("cancel-exit");
const confirmExitBtn = document.getElementById("confirm-exit");
let shouldExit = false;
window.addEventListener("beforeunload", function (e) {
  if (unsavedChanges && !shouldExit) {
    e.preventDefault();
    e.returnValue = "";
    exitDialog.classList.remove("hidden");
    return "";
  }
});
confirmExitBtn.addEventListener("click", () => {
  shouldExit = true;
  exitDialog.classList.add("hidden");
  window.location.href = "about:blank";
});
cancelExitBtn.addEventListener("click", () => {
  exitDialog.classList.add("hidden");
});

function startInteraction() {
  isInteracting = true;
  drawCanvas();
  clearTimeout(interactionTimeout);
}
function endInteraction() {
  clearTimeout(interactionTimeout);
  interactionTimeout = setTimeout(() => {
    isInteracting = false;
    drawCanvas();
  }, 300);
}

canvas.addEventListener("mousedown", e => {
  isDragging = true;
  lastTouch = { x: e.offsetX, y: e.offsetY };
  startInteraction();
});
canvas.addEventListener("mousemove", e => {
  if (isDragging) {
    const dx = e.offsetX - lastTouch.x;
    const dy = e.offsetY - lastTouch.y;
    position.x += dx;
    position.y += dy;
    lastTouch = { x: e.offsetX, y: e.offsetY };
    drawCanvas();
  }
});
canvas.addEventListener("mouseup", () => { isDragging = false; endInteraction(); });
canvas.addEventListener("mouseleave", () => { isDragging = false; endInteraction(); });

canvas.addEventListener("wheel", e => {
  e.preventDefault();
  const delta = e.deltaY < 0 ? 0.05 : -0.05;
  scale = Math.max(0.1, Math.min(5, scale + delta));
  startInteraction();
  drawCanvas();
  endInteraction();
});

canvas.addEventListener("touchstart", e => {
  if (e.touches.length === 1) {
    isDragging = true;
    const touch = e.touches[0];
    lastTouch = getTouchPos(touch);
  } else if (e.touches.length === 2) {
    initialDistance = getDistance(e.touches);
  }
  startInteraction();
}, { passive: false });

canvas.addEventListener("touchmove", e => {
  e.preventDefault();
  if (e.touches.length === 1 && isDragging) {
    const touch = getTouchPos(e.touches[0]);
    const dx = touch.x - lastTouch.x;
    const dy = touch.y - lastTouch.y;
    position.x += dx;
    position.y += dy;
    lastTouch = touch;
    drawCanvas();
  } else if (e.touches.length === 2 && initialDistance !== null) {
    const newDist = getDistance(e.touches);
    const zoom = newDist / initialDistance;
    scale = Math.max(0.1, Math.min(5, scale * zoom));
    initialDistance = newDist;
    drawCanvas();
  }
}, { passive: false });

canvas.addEventListener("touchend", () => {
  isDragging = false;
  initialDistance = null;
  endInteraction();
});

function getTouchPos(touch) {
  const rect = canvas.getBoundingClientRect();
  return {
    x: touch.clientX - rect.left,
    y: touch.clientY - rect.top
  };
}

function getDistance(touches) {
  const dx = touches[0].clientX - touches[1].clientX;
  const dy = touches[0].clientY - touches[1].clientY;
  return Math.sqrt(dx * dx + dy * dy);
}

updateSteps();
</script>
  <script>
    const exitDialog = document.getElementById("exit-dialog");
    const cancelExitBtn = document.getElementById("cancel-exit");
    const confirmExitBtn = document.getElementById("confirm-exit");
    let shouldExit = false;

    window.addEventListener("beforeunload", function (e) {
      if (typeof unsavedChanges !== 'undefined' && unsavedChanges && !shouldExit) {
        e.preventDefault();
        e.returnValue = "";
        exitDialog.classList.remove("hidden");
        return "";
      }
    });

    confirmExitBtn.addEventListener("click", () => {
      shouldExit = true;
      exitDialog.classList.add("hidden");
      window.location.href = "about:blank";
    });

    cancelExitBtn.addEventListener("click", () => {
      exitDialog.classList.add("hidden");
    });
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => console.log('Service Worker registered:', reg))
          .catch(err => console.log('Service Worker registration failed:', err));
      });
    }
  </script>
</body>
</html>
